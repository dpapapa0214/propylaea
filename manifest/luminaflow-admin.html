<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuminaFlow Admin - 記事管理</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
   <link rel="icon" href="icons/logo-newspaper.png">
    <link rel="apple-touch-icon" href="icons/logo-newspaper.png">
    <link rel="manifest" href="/manifest/manifest-luminaflow.json">

    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f8fafc; }
        .glass-preview {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        .preview-scroll::-webkit-scrollbar { width: 4px; }
        .preview-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .tab-active { border-bottom: 2px solid #e11d48; color: #e11d48; font-weight: bold; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ★ GASのウェブアプリURLをここに設定してください ★
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzf3oiH-MGpGaJ6ojBWeNFJVo9JzO5W6uCDVWU9aD6d3PQICeM9U04VwbGHkhwNlLQpJg/exec"; 

        const CATEGORIES = [
            "テクノロジー", "ビジネス", "経済", "政治", "国際", "国内", "スポーツ", "エンタメ", 
            "ライフスタイル", "ヘルスケア", "グルメ", "旅行", "ファッション", "美容", "アート", 
            "サイエンス", "宇宙", "自動車", "ガジェット", "ゲーム", "環境・SDGs"
        ];

        const InputField = ({ label, name, value, onChange, type = "text", placeholder, required = false, heightClass = "h-32" }) => (
            <div className="mb-4">
                <label className="block text-sm font-bold text-slate-700 mb-2">{label} {required && <span className="text-red-500">*</span>}</label>
                {type === "textarea" ? (
                    <textarea 
                        name={name} value={value} onChange={onChange} placeholder={placeholder}
                        className={`w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500 ${heightClass} transition-shadow`}
                    />
                ) : (
                    <input 
                        type={type} name={name} value={value} onChange={onChange} placeholder={placeholder}
                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500 transition-shadow"
                    />
                )}
            </div>
        );

        const AdminApp = () => {
            const [mode, setMode] = useState('single'); // 'single' | 'bulk'
            const [formData, setFormData] = useState({
                title: "", summary: "", content: "", category: "テクノロジー", image: "", author: "", featured: false, references: ""
            });
            const [bulkText, setBulkText] = useState("");
            const [parsedData, setParsedData] = useState([]);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [status, setStatus] = useState(null);

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({ ...prev, [name]: type === "checkbox" ? checked : value }));
            };

            const currentDate = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '.');

            // --- CSV/TSV パース処理 ---
            const parseBulkData = () => {
                if (!bulkText.trim()) return;
                
                try {
                    // JSON形式の試行
                    const jsonData = JSON.parse(bulkText);
                    if (Array.isArray(jsonData)) {
                        setParsedData(jsonData);
                        setStatus({ type: 'success', message: `JSONとして ${jsonData.length} 件の記事を認識しました。` });
                        return;
                    }
                } catch (e) {
                    // JSONでなければTSV/CSVとして処理
                }

                // TSV/CSV 処理 (簡易版: 1行1記事、タブ区切り推奨)
                // フォーマット: Title [TAB] Category [TAB] Author [TAB] ImageURL [TAB] Summary [TAB] Content [TAB] References
                const lines = bulkText.split('\n').filter(line => line.trim() !== '');
                const items = lines.map((line, index) => {
                    // タブ区切りを優先、なければカンマ
                    const separator = line.includes('\t') ? '\t' : ',';
                    const parts = line.split(separator).map(p => p.trim());
                    
                    return {
                        title: parts[0] || `No Title ${index + 1}`,
                        category: parts[1] || "General",
                        author: parts[2] || "Admin",
                        image: parts[3] || "",
                        summary: parts[4] || "",
                        content: parts[5] || parts[0] || "",
                        references: parts[6] || "", // 7番目のカラムをReferencesとして扱う
                        featured: false,
                        date: new Date().toISOString()
                    };
                });
                
                setParsedData(items);
                setStatus({ type: 'success', message: `${items.length} 件の記事データを解析しました。プレビューを確認して送信してください。` });
            };

            const handleSubmitSingle = async (e) => {
                e.preventDefault();
                await sendToGas([ { ...formData, date: new Date().toISOString() } ]);
            };

            const handleSubmitBulk = async () => {
                if (parsedData.length === 0) return;
                await sendToGas(parsedData);
            };

            const sendToGas = async (dataPayload) => {
                setIsSubmitting(true);
                setStatus(null);

                try {
                    if (!GAS_API_URL || GAS_API_URL.includes("YOUR_GAS_WEB_APP_URL")) {
                        await new Promise(r => setTimeout(r, 1000)); // Demo delay
                        console.log("Mock Submit:", dataPayload);
                        setStatus({ type: 'success', message: `送信成功 (デモ): ${dataPayload.length} 件の記事が処理されました。` });
                    } else {
                        const response = await fetch(GAS_API_URL, {
                            method: 'POST',
                            body: JSON.stringify(dataPayload)
                        });
                        const resJson = await response.json();
                        
                        if (resJson.status === 'success') {
                            setStatus({ type: 'success', message: `送信成功: ${resJson.message}` });
                            // リセット
                            if (mode === 'single') {
                                setFormData({ title: "", summary: "", content: "", category: "テクノロジー", image: "", author: "", featured: false, references: "" });
                            } else {
                                setBulkText("");
                                setParsedData([]);
                            }
                        } else {
                            throw new Error(resJson.message);
                        }
                    }
                } catch (error) {
                    setStatus({ type: 'error', message: '送信エラー: ' + error.message });
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    
                    {/* Left: Editor Panel */}
                    <div className="w-full md:w-1/2 p-6 md:p-12 overflow-y-auto bg-white border-r border-slate-200 h-screen">
                        <div className="max-w-xl mx-auto">
                            <h1 className="text-2xl font-bold text-slate-800 mb-2 flex items-center">
                                <span className="text-rose-600 mr-2">✦</span> LuminaFlow Admin
                            </h1>
                            
                            {/* Tab Switcher */}
                            <div className="flex space-x-6 border-b border-slate-200 mb-6">
                                <button 
                                    onClick={() => { setMode('single'); setStatus(null); }}
                                    className={`pb-3 text-sm font-medium transition-colors ${mode === 'single' ? 'tab-active' : 'tab-inactive hover:text-slate-800'}`}
                                >
                                    個別作成 (Single)
                                </button>
                                <button 
                                    onClick={() => { setMode('bulk'); setStatus(null); }}
                                    className={`pb-3 text-sm font-medium transition-colors ${mode === 'bulk' ? 'tab-active' : 'tab-inactive hover:text-slate-800'}`}
                                >
                                    一括投稿 (Bulk Upload)
                                </button>
                            </div>

                            {status && (
                                <div className={`p-4 rounded-lg mb-6 text-sm ${status.type === 'success' ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}`}>
                                    {status.message}
                                </div>
                            )}

                            {mode === 'single' ? (
                                /* --- Single Form --- */
                                <form onSubmit={handleSubmitSingle} className="animate-in fade-in duration-300">
                                    <InputField label="タイトル" name="title" value={formData.title} onChange={handleChange} placeholder="記事のタイトルを入力" required />
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="mb-4">
                                            <label className="block text-sm font-bold text-slate-700 mb-2">カテゴリ</label>
                                            <select name="category" value={formData.category} onChange={handleChange} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500">
                                                {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </div>
                                        <InputField label="著者名" name="author" value={formData.author} onChange={handleChange} placeholder="例: 佐藤 健一" required />
                                    </div>

                                    <InputField label="画像URL" name="image" value={formData.image} onChange={handleChange} placeholder="https://..." />
                                    <InputField label="概要 (リード文)" name="summary" type="textarea" value={formData.summary} onChange={handleChange} placeholder="一覧画面に表示される短い説明" heightClass="h-24" />
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-bold text-slate-700 mb-2">本文 *</label>
                                        <textarea 
                                            name="content" value={formData.content} onChange={handleChange} placeholder="記事の本文を入力..."
                                            className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500 h-64 font-mono text-sm leading-relaxed"
                                        />
                                    </div>

                                    <InputField label="引用・参考文献" name="references" type="textarea" value={formData.references} onChange={handleChange} placeholder="出典元などを入力してください（改行でリスト表示されます）" heightClass="h-24" />

                                    <div className="mb-8 flex items-center">
                                        <input type="checkbox" id="featured" name="featured" checked={formData.featured} onChange={handleChange} className="w-5 h-5 text-rose-600 rounded focus:ring-rose-500 border-gray-300" />
                                        <label htmlFor="featured" className="ml-2 text-slate-700 font-medium">Featured記事としてトップに表示</label>
                                    </div>

                                    <button 
                                        type="submit" 
                                        disabled={isSubmitting}
                                        className={`w-full py-3 px-4 rounded-full font-bold text-white shadow-lg transition-all ${
                                            isSubmitting ? 'bg-slate-400 cursor-not-allowed' : 'bg-slate-900 hover:bg-slate-800 hover:shadow-xl hover:-translate-y-1'
                                        }`}
                                    >
                                        {isSubmitting ? '送信中...' : '記事を公開する'}
                                    </button>
                                </form>
                            ) : (
                                /* --- Bulk Form --- */
                                <div className="animate-in fade-in duration-300">
                                    <div className="bg-slate-50 p-4 rounded-lg mb-4 text-xs text-slate-600 border border-slate-200">
                                        <p className="font-bold mb-1">フォーマット (TSV: タブ区切り推奨)</p>
                                        <code className="block bg-white p-2 rounded border border-slate-200 mb-2 overflow-x-auto">
                                            Title [TAB] Category [TAB] Author [TAB] ImageURL [TAB] Summary [TAB] Content [TAB] References
                                        </code>
                                        <p>※ Excelやスプレッドシートからコピー＆ペーストできます。</p>
                                        <p>※ JSON形式の配列データも受け付けます。</p>
                                    </div>

                                    <div className="mb-4">
                                        <textarea 
                                            value={bulkText} 
                                            onChange={(e) => setBulkText(e.target.value)}
                                            placeholder={`例:\n新製品発表\tテクノロジー\t佐藤\thttps://...\t概要文\t本文テキスト\t出典: 公式サイト\n市場調査\tビジネス\t鈴木\thttps://...\t概要文\t本文テキスト\t参考文献A\n参考文献B`}
                                            className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500 h-64 font-mono text-xs leading-relaxed whitespace-pre"
                                        />
                                    </div>

                                    <div className="flex space-x-3 mb-6">
                                        <button 
                                            onClick={parseBulkData}
                                            className="px-4 py-2 bg-slate-200 text-slate-700 font-bold rounded-lg hover:bg-slate-300 transition-colors"
                                        >
                                            解析 & プレビュー
                                        </button>
                                        {parsedData.length > 0 && (
                                            <button 
                                                onClick={handleSubmitBulk}
                                                disabled={isSubmitting}
                                                className="flex-1 px-4 py-2 bg-rose-600 text-white font-bold rounded-lg hover:bg-rose-700 transition-colors shadow-md"
                                            >
                                                {isSubmitting ? '送信中...' : `${parsedData.length} 件を一括送信`}
                                            </button>
                                        )}
                                    </div>

                                    {/* Parsed Preview Table */}
                                    {parsedData.length > 0 && (
                                        <div className="overflow-x-auto border border-slate-200 rounded-lg">
                                            <table className="min-w-full text-xs text-left text-slate-600">
                                                <thead className="bg-slate-50 font-bold text-slate-700 border-b border-slate-200">
                                                    <tr>
                                                        <th className="px-3 py-2">#</th>
                                                        <th className="px-3 py-2">Title</th>
                                                        <th className="px-3 py-2">Category</th>
                                                        <th className="px-3 py-2">Author</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {parsedData.map((item, i) => (
                                                        <tr key={i} className="border-b border-slate-100 hover:bg-slate-50">
                                                            <td className="px-3 py-2">{i + 1}</td>
                                                            <td className="px-3 py-2 font-medium text-slate-800">{item.title}</td>
                                                            <td className="px-3 py-2">{item.category}</td>
                                                            <td className="px-3 py-2">{item.author}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Right: Mobile Preview */}
                    <div className="w-full md:w-1/2 bg-slate-100 flex items-center justify-center p-8 h-screen sticky top-0 hidden md:flex">
                        <div className="relative w-[375px] h-[812px] bg-white rounded-[3rem] shadow-2xl border-8 border-slate-900 overflow-hidden flex flex-col">
                            {/* iPhone Notch */}
                            <div className="absolute top-0 left-1/2 transform -translate-x-1/2 w-40 h-7 bg-slate-900 rounded-b-2xl z-20"></div>
                            
                            {/* App Header */}
                            <div className="pt-12 pb-4 px-6 bg-white/80 backdrop-blur-md border-b border-slate-100 z-10">
                                <div className="flex justify-between items-center">
                                    <span className="font-bold text-lg">Lumina<span className="text-rose-600">Flow</span></span>
                                    <div className="w-8 h-8 bg-rose-100 rounded-full flex items-center justify-center text-rose-600 text-xs font-bold">A</div>
                                </div>
                            </div>

                            {/* Preview Content */}
                            <div className="flex-1 overflow-y-auto preview-scroll bg-slate-50 relative">
                                {mode === 'single' ? (
                                    !formData.title ? (
                                        <div className="h-full flex items-center justify-center text-slate-400 p-8 text-center text-sm">
                                            左側のエディタに入力すると<br/>ここにプレビューが表示されます
                                        </div>
                                    ) : (
                                        <div className="animate-in fade-in">
                                            <div className="relative h-64">
                                                <img src={formData.image || "https://images.unsplash.com/photo-1504711434969-e33886168f5c?auto=format&fit=crop&q=80&w=800"} className="w-full h-full object-cover" />
                                                <div className="absolute inset-0 bg-gradient-to-b from-transparent to-black/80"></div>
                                                <div className="absolute bottom-4 left-4 right-4">
                                                    <span className="inline-block bg-rose-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-full mb-2 uppercase">{formData.category}</span>
                                                    <h2 className="text-xl font-bold text-white leading-tight shadow-sm">{formData.title}</h2>
                                                </div>
                                            </div>
                                            <div className="p-6">
                                                <div className="flex items-center justify-between text-xs text-slate-400 mb-4">
                                                    <span>{formData.author || "Author"}</span>
                                                    <span>{currentDate}</span>
                                                </div>
                                                <p className="text-slate-600 font-medium mb-6 italic border-l-2 border-rose-500 pl-3 text-sm">{formData.summary || "概要..."}</p>
                                                <div className="text-slate-700 text-sm leading-relaxed whitespace-pre-wrap">{formData.content || "本文..."}</div>
                                                
                                                {/* References Section */}
                                                {formData.references && (
                                                    <div className="mt-8 pt-6 border-t border-slate-100">
                                                        <h4 className="font-bold text-slate-800 text-xs mb-3">引用・参考文献</h4>
                                                        <ul className="text-xs text-slate-500 space-y-2">
                                                            {formData.references.split('\n').map((ref, idx) => (
                                                                ref.trim() && (
                                                                    <li key={idx} className="flex items-start">
                                                                        <span className="mr-2 text-rose-400">•</span>
                                                                        <span>{ref}</span>
                                                                    </li>
                                                                )
                                                            ))}
                                                        </ul>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )
                                ) : (
                                    <div className="h-full flex items-center justify-center text-slate-400 p-8 text-center text-sm">
                                        一括投稿モード<br/>プレビューは「解析」後に<br/>リストで確認できます
                                    </div>
                                )}
                            </div>
                            
                            <div className="h-1 bg-slate-900 w-1/3 mx-auto mb-2 rounded-full opacity-20"></div>
                        </div>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
    </script>
</body>
</html>
